name: Building and Testing

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**/*'
      - LICENSE
      - .gitignore
      - '**/*.toml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # --- Detect which areas changed ---
  detect-changes:
    name: Detect file changes
    runs-on: ubuntu-latest
    outputs:
      iso3166_2: ${{ steps.filter.outputs.iso3166_2 }}
      scripts: ${{ steps.filter.outputs.scripts }}
    steps:
      - uses: actions/checkout@v4
      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            iso3166_2:
              - 'iso3166_2/**'
            scripts:
              - 'scripts/**'

  # --- Unit tests: iso3166_2 subset ---
  test-iso3166_2:
    name: Tests (iso3166_2 subset)
    needs: detect-changes
    if: github.event_name != 'workflow_dispatch' && needs.detect-changes.outputs.iso3166_2 == 'true'
    timeout-minutes: 15
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          pip install -e . || true
          pip install pytest
          if [ -f tests/requirements.txt ]; then pip install -r tests/requirements.txt; fi

      - name: Run iso3166_2-specific tests
        run: |
          pytest -v \
            tests/test_iso3166_2.py \
            tests/test_iso3166_2_api.py \
            tests/test_metadata.py

  # --- Unit tests: scripts subset ---
  test-scripts:
    name: Tests (scripts subset)
    needs: detect-changes
    if: github.event_name != 'workflow_dispatch' && needs.detect-changes.outputs.scripts == 'true'
    timeout-minutes: 15
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          pip install -e . || true
          pip install pytest
          if [ -f tests/requirements.txt ]; then pip install -r tests/requirements.txt; fi

      - name: Run scripts-related tests
        run: |
          pytest -v \
            tests/test_language_lookup.py \
            tests/test_local_other_names.py \
            tests/test_update_subdivisions.py \
            tests/test_utils.py \
            tests/test_main.py \
            tests/test_demographics.py \
            tests/test_geo.py \
            tests/test_history.py \
            tests/test_restcountries_api.py \
            tests/test_city_data.py

  # --- Full suite with coverage ---
  test-full-suite:
    name: Tests (full suite with coverage)
    needs: detect-changes
    if: github.event_name == 'workflow_dispatch' || (needs.detect-changes.outputs.iso3166_2 != 'true' && needs.detect-changes.outputs.scripts != 'true')
    timeout-minutes: 20
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          pip install -e . || true
          pip install pytest pytest-cov codecov
          if [ -f tests/requirements.txt ]; then pip install -r tests/requirements.txt; fi

      - name: Run full test suite with coverage
        run: |
          pytest -v --cov=. --cov-report=xml

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4

  # --- Security Scan ---
  security-scan:
    name: Security Scan
    needs: [test-iso3166_2, test-scripts, test-full-suite]
    timeout-minutes: 15
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit bandit

      - name: Create artifacts folder
        run: mkdir artifacts

      - name: Run pip-audit
        run: |
          pip-audit > artifacts/pip_audit_output.txt
          cat artifacts/pip_audit_output.txt
        continue-on-error: true

      - name: Run Bandit
        run: |
          bandit -r iso3166_2 tests scripts > artifacts/bandit_output.txt
          cat artifacts/bandit_output.txt
        continue-on-error: true

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-artifacts
          path: artifacts/

  # --- Flake8 Linter ---
  flake8-lint:
    name: Flake8 Lint
    needs: [test-iso3166_2, test-scripts, test-full-suite]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install flake8
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest

      - name: Create artifacts directory
        run: mkdir flake8_artifacts

      - name: Run flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics > flake8_artifacts/flake8_output.txt
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics >> flake8_artifacts/flake8_output.txt
        continue-on-error: true

      - name: Upload flake8 artifact
        uses: actions/upload-artifact@v4
        with:
          name: flake8-artifact
          path: flake8_artifacts/flake8_output.txt